substitutions:
  name: tracer
  prefix: MPPT
  update_interval: 10s
  disabled_by_default: 'true'
  DI: GPIO19
  RO: GPIO18
  REDE: GPIO23
  timezone: Europe/Berlin
esphome:
  name: tracer
  project:
    name: cubinet-code.epever_mppt_controller
    version: 1.0.0
  build_path: build/tracer
  friendly_name: ''
  area: ''
  platformio_options: {}
  includes: []
  libraries: []
  name_add_mac_suffix: false
  min_version: 2023.11.6
esp32:
  board: esp-wrover-kit
  framework:
    version: 2.0.5
    source: ~3.20005.0
    platform_version: platformio/espressif32@5.4.0
    type: arduino
  flash_size: 4MB
  variant: ESP32
sensor:
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: array_rated_voltage
  name: 'MPPT SPEC: PV Rated Voltage'
  address: 12288
  unit_of_measurement: V
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: array_rated_current
  name: 'MPPT SPEC: PV Rated Current'
  address: 12289
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: array_rated_power
  name: 'MPPT SPEC: PV Rated Power'
  address: 12290
  register_count: 2
  unit_of_measurement: W
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:flash
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: battery_rated_voltage
  name: 'MPPT SPEC: Battery Rated Voltage'
  address: 12292
  unit_of_measurement: V
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: battery_rated_current
  name: 'MPPT SPEC: Rated charging current'
  address: 12293
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  id: battery_rated_power
  name: 'MPPT SPEC: Battery Rated Power'
  address: 12294
  unit_of_measurement: W
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:flash
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  id: rated_current_of_load
  name: 'MPPT SPEC: Rated load current'
  address: 12302
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  force_update: false
  bitmask: 0xFFFFFFFF
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT RT: PV Input Voltage'
  address: 12544
  unit_of_measurement: V
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: pv_input_current
  name: 'MPPT RT: PV Input Current'
  address: 12545
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: pv_input_power
  name: 'MPPT RT: PV Input Power'
  address: 12546
  unit_of_measurement: W
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:flash
  device_class: power
  state_class: measurement
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: charging_voltage
  name: 'MPPT RT: Charging Voltage'
  address: 12548
  unit_of_measurement: V
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: charging_current
  name: 'MPPT RT: Charging Current'
  address: 12549
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: charging_power
  name: 'MPPT RT: Charging Power'
  address: 12550
  unit_of_measurement: W
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:flash
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: load_voltage
  name: 'MPPT RT: Load Voltage'
  address: 12556
  unit_of_measurement: V
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: load_current
  name: 'MPPT RT: Load Current'
  address: 12557
  unit_of_measurement: A
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: load_power
  name: 'MPPT RT: Load Power'
  address: 12558
  unit_of_measurement: W
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  icon: mdi:flash
  device_class: power
  state_class: measurement
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: battery_temperature
  name: 'MPPT RT: Battery Temperature'
  address: 12560
  unit_of_measurement: °C
  register_type: read
  value_type: S_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: device_temperature
  name: 'MPPT RT: Device Temperature'
  address: 12561
  unit_of_measurement: °C
  register_type: read
  value_type: S_WORD
  accuracy_decimals: 2
  filters:
  - multiply: 0.01
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: power_components_temperature
  name: 'MPPT RT: Power Components Temperature'
  address: 12562
  unit_of_measurement: °C
  register_type: read
  value_type: S_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: battery_soc
  name: 'MPPT RT: Battery SOC'
  address: 12570
  unit_of_measurement: '%'
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 0
  icon: mdi:battery-high
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: remote_battery_temperature
  name: 'MPPT RT: Remote Battery Temperature'
  address: 12571
  unit_of_measurement: °C
  register_type: read
  value_type: S_WORD
  accuracy_decimals: 1
  filters:
  - multiply: 0.01
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT RT: Current System Rated Voltage'
  address: 12573
  unit_of_measurement: V
  register_type: read
  value_type: S_WORD
  accuracy_decimals: 0
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: max_pv_voltage_today
  name: 'MPPT STAT: Maximum PV Voltage Today'
  address: 13056
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  unit_of_measurement: V
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: min_pv_voltage_today
  name: 'MPPT STAT: Minimum PV Voltage Today'
  address: 13057
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  unit_of_measurement: V
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: max_battery_voltage_today
  name: 'MPPT STAT: Maximum Battery Voltage Today'
  address: 13058
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  unit_of_measurement: V
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: min_battery_today
  name: 'MPPT STAT: Minimum Battery Voltage Today'
  address: 13059
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  unit_of_measurement: V
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT STAT: Consumed Energy Today'
  address: 13060
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  device_class: energy
  state_class: total_increasing
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: consumed_energy_month
  name: 'MPPT STAT: Consumed Energy Month'
  address: 13062
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: consumed_energy_year
  name: 'MPPT STAT: Consumed Energy Year'
  address: 13064
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: consumed_energy_total
  name: 'MPPT STAT: Consumed energy total'
  address: 13066
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: generated_energy_today
  name: 'MPPT STAT: Generated Energy Today'
  address: 13068
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  device_class: energy
  state_class: total_increasing
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: generated_energy_month
  name: 'MPPT STAT: Generated Energy Month'
  address: 13070
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: generated_energy_year
  name: 'MPPT STAT: Generated Energy Year'
  address: 13072
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: generated_energy_total
  name: 'MPPT STAT: Generated Energy Total'
  address: 13074
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kWh
  filters:
  - multiply: 0.01
  icon: mdi:counter
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: co2_reduction
  name: 'MPPT STAT: CO₂ Reduction'
  address: 13076
  register_type: read
  value_type: U_DWORD_R
  accuracy_decimals: 2
  unit_of_measurement: kg
  filters:
  - multiply: 10.0
  icon: mdi:molecule-co2
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: battery_voltage
  name: 'MPPT STAT: Battery Voltage'
  address: 13082
  register_type: read
  value_type: U_WORD
  accuracy_decimals: 2
  unit_of_measurement: V
  filters:
  - multiply: 0.01
  icon: mdi:sine-wave
  on_value:
  - then:
    - sensor.template.publish:
        id: real_soc
        state: !lambda |-
          return x*2;
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: template
  id: real_soc
  name: 'MPPT STAT: Battery SOC'
  disabled_by_default: false
  force_update: false
  accuracy_decimals: 1
  update_interval: 60s
- platform: modbus_controller
  modbus_controller_id: epever
  id: mppt_stat_battery_current
  name: 'MPPT STAT: Battery Current'
  address: 13083
  register_type: read
  value_type: S_DWORD_R
  register_count: 2
  accuracy_decimals: 2
  unit_of_measurement: A
  filters:
  - multiply: 0.01
  icon: mdi:current-dc
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: integration
  name: 'MPPT RT: Battery SOC Ah'
  id: mppt_rt_battery_soc_ah
  sensor: mppt_stat_battery_current
  time_unit: h
  integration_method: trapezoid
  icon: mdi:sine-wave
  on_value:
  - then:
    - lambda: !lambda "if (id(mppt_rt_battery_soc_ah).state > 0.05){ \n  id(mppt_rt_battery_soc_ah).reset();\n\
        };"
  disabled_by_default: false
  force_update: false
  restore: false
  unit_of_measurement: Ah
  accuracy_decimals: 4
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36889
  name: 'MPPT SET: Controller inner temperature upper limit'
  icon: mdi:thermometer-chevron-down
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  filters:
  - multiply: 0.01
  accuracy_decimals: 2
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36890
  name: 'MPPT SET: Controller inner temperature upper limit recover'
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  filters:
  - multiply: 0.01
  accuracy_decimals: 2
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36891
  name: 'MPPT SET: Power component temperature upper limit'
  icon: mdi:thermometer-chevron-down
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  filters:
  - multiply: 0.01
  accuracy_decimals: 2
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36892
  name: 'MPPT SET: Power component temperature upper limit recover'
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  filters:
  - multiply: 0.01
  accuracy_decimals: 2
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36893
  name: 'MPPT SET: Line Impedance'
  unit_of_measurement: mOhm
  register_type: holding
  value_type: U_WORD
  filters:
  - multiply: 0.01
  accuracy_decimals: 2
  icon: mdi:omega
  disabled_by_default: false
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  address: 36930
  name: 'MPPT LC: #1 Turn on time 1 (s)'
  register_type: holding
  unit_of_measurement: s
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_on_time_1_minutes
  address: 36931
  name: 'MPPT LC: #1 Turn on time 1 (m)'
  register_type: holding
  unit_of_measurement: min
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_on_time_1_hours
  address: 36932
  name: 'MPPT LC: #1 Turn on time 1 (h)'
  register_type: holding
  unit_of_measurement: h
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_1_seconds
  address: 36933
  name: 'MPPT LC: #1 Turn off time 1 (s)'
  register_type: holding
  unit_of_measurement: s
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_1_minutes
  address: 36934
  name: 'MPPT LC: #1 Turn off time 1 (m)'
  register_type: holding
  unit_of_measurement: min
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_1_hours
  address: 36935
  name: 'MPPT LC: #1 Turn off time 1 (h)'
  register_type: holding
  unit_of_measurement: h
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_on_time_2_seconds
  address: 36936
  name: 'MPPT LC: #1 Turn on time 2 (s)'
  unit_of_measurement: s
  register_type: holding
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_on_time_2_minutes
  address: 36937
  name: 'MPPT LC: #1 Turn on time 2 (m)'
  register_type: holding
  unit_of_measurement: min
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_on_time_2_hours
  address: 36938
  name: 'MPPT LC: #1 Turn on time 2 (h)'
  register_type: holding
  unit_of_measurement: h
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_2_seconds
  address: 36939
  name: 'MPPT LC: #1 Turn off time 2 (s)'
  register_type: holding
  unit_of_measurement: s
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_2_minutes
  address: 36940
  name: 'MPPT LC: #1 Turn off time 2 (m)'
  register_type: holding
  unit_of_measurement: min
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: turn_off_time_2_hours
  address: 36941
  name: 'MPPT LC: #1 Turn off time 2 (h)'
  register_type: holding
  unit_of_measurement: h
  accuracy_decimals: 0
  value_type: U_WORD
  icon: mdi:clock-digital
  force_update: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: x9065_m
  address: 36965
  bitmask: 0xFF
  unit_of_measurement: min
  name: 'MPPT LC: #2 Duration Of Night (m)'
  register_type: holding
  value_type: U_WORD
  icon: mdi:timer
  disabled_by_default: false
  force_update: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: x9065_h
  address: 36965
  bitmask: 0xFF00
  unit_of_measurement: h
  name: 'MPPT LC: #2 Duration Of Night (h)'
  register_type: holding
  value_type: U_WORD
  icon: mdi:timer
  disabled_by_default: false
  force_update: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  register_count: 0
- platform: wifi_signal
  name: MPPT ESP WiFi Signal
  update_interval: 10s
  entity_category: diagnostic
  disabled_by_default: false
  force_update: false
  unit_of_measurement: dBm
  accuracy_decimals: 0
  device_class: signal_strength
  state_class: measurement
text_sensor:
- platform: modbus_controller
  skip_updates: 100
  disabled_by_default: true
  modbus_controller_id: epever
  name: 'MPPT SPEC: Charging Mode'
  register_type: read
  address: 12296
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    switch (value) { \n  case 0x0: return std::string(\"Connect/disconnect\");\n \
    \ case 0x1: return std::string(\"PWM\");\n  case 0x2: return std::string(\"MPPT\"\
    );\n  default: return std::string(\"Unknown\");\n}"
  bitmask: 0xFFFFFFFF
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT OP: Day/Night'
  address: 8204
  register_type: discrete_input
  raw_encode: NONE
  icon: mdi:weather-sunset-up
  lambda: !lambda "uint16_t value = data[item->offset];\nswitch (value) { \n  case\
    \ 0x0: return std::string(\"Day\");\n  case 0x1: return std::string(\"Night\"\
    );\n  default:  return esphome::to_string(value);\n}\nreturn x;"
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT OP: System Time'
  internal: false
  register_type: holding
  address: 36883
  register_count: 3
  raw_encode: HEXBYTES
  icon: mdi:clock-outline
  lambda: !lambda |-
    uint8_t m = esphome::modbus_controller::byte_from_hex_str(x,0);
    uint8_t s = esphome::modbus_controller::byte_from_hex_str(x,1);
    uint8_t d = esphome::modbus_controller::byte_from_hex_str(x,2);
    uint8_t h = esphome::modbus_controller::byte_from_hex_str(x,3);
    uint8_t y = esphome::modbus_controller::byte_from_hex_str(x,4);
    uint8_t M = esphome::modbus_controller::byte_from_hex_str(x,5);

    char buf[20];
    sprintf(buf, "%04d-%02d-%02d %02d:%02d:%02d", y+2000, M, d, h, m, s);
    return std::string(buf);
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT RT: Over Temperature Inside The Device'
  address: 8192
  register_type: discrete_input
  raw_encode: NONE
  lambda: !lambda "uint16_t value = data[item->offset];\nswitch (value) { \n  case\
    \ 0x0: return std::string(\"Normal\");\n  case 0x1: return std::string(\"Higher\
    \ Than Over Temp Setting\");\n  default:  return esphome::to_string(value);\n\
    }\nreturn x;"
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging PV Input Voltage Status'
  register_type: read
  address: 12801
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 14;   \nvalue = value & 0x3; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits\
    \ */\nswitch (value) { \n  case 0x0: return std::string(\"Normal\");\n  case 0x1:\
    \ return std::string(\"No Input Power\");\n  case 0x2: return std::string(\"Higher\
    \ Input Voltage\");\n  case 0x3: return std::string(\"Input Voltage Error\");\n\
    \  default: return std::string(\"Unknown\");\n}\nreturn x;"
  icon: mdi:sine-wave
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  id: mppt_chg_charging_status
  name: 'MPPT CHG: Charging Status'
  register_type: read
  address: 12801
  raw_encode: NONE
  icon: mdi:battery-charging
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 2;   /* starting D2 */\nvalue = value & 0x3; /* for two bits\
    \ */\nswitch (value) { \n  case 0x0: return std::string(\"Not charging\");\n \
    \ case 0x1: return std::string(\"Float\");\n  case 0x2: return std::string(\"\
    Boost\");\n  case 0x3: return std::string(\"Equalization\");\n  default: return\
    \ std::string(\"Unknown\");\n}\nreturn x;"
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Health'
  register_type: read
  force_new_range: true
  address: 12801
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 1;\nvalue = value & 0x1; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits */\n\
    switch (value) { \n  case 0x0: return std::string(\"Idle\");\n  case 0x1: return\
    \ std::string(\"Normal\");\n  default: return std::string(\"Unknown\");\n}\nreturn\
    \ x;"
  icon: mdi:pulse
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging State'
  register_type: read
  address: 12801
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value & 0x1; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits */\nswitch (value) { \n\
    \  case 0x0: return std::string(\"Standby\");\n  case 0x1: return std::string(\"\
    Running\");\n  default: return std::string(\"Unknown\");\n}\nreturn x;"
  icon: mdi:battery-positive
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Register'
  force_new_range: true
  register_type: read
  address: 12801
  raw_encode: HEXBYTES
  lambda: !lambda |-
    return x;
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Input Voltage'
  register_type: read
  address: 12802
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 14;   \nvalue = value & 0x3; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits\
    \ */\nswitch (value) { \n  case 0x0: return std::string(\"Normal\");\n  case 0x1:\
    \ return std::string(\"Low\");\n  case 0x2: return std::string(\"High\");\n  case\
    \ 0x3: return std::string(\"No Access\");\n  default: return std::string(\"Unknown\"\
    );\n}\nreturn x;"
  icon: mdi:sine-wave
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Output Power'
  register_type: read
  address: 12802
  raw_encode: NONE
  icon: mdi:flash
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 12;   \nvalue = value & 0x3; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits\
    \ */\nswitch (value) { \n  case 0x0: return std::string(\"Light Load\");\n  case\
    \ 0x1: return std::string(\"Moderate Load\");\n  case 0x2: return std::string(\"\
    Rated\");\n  case 0x3: return std::string(\"Overload\");\n  default: return std::string(\"\
    Unknown\");\n}\nreturn x;\n\n  "
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Health'
  register_type: read
  address: 12802
  raw_encode: NONE
  icon: mdi:pulse
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 1;\nvalue = value & 0x1; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits */\n\
    switch (value) { \n  case 0x0: return std::string(\"Normal\");\n  case 0x1: return\
    \ std::string(\"Fault\");\n  default: return std::string(\"Unknown\");\n}\nreturn\
    \ x;"
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging State'
  register_type: read
  address: 12802
  raw_encode: HEXBYTES
  icon: mdi:battery-negative
  lambda: !lambda "uint16_t value = modbus_controller::word_from_hex_str(x, 0);\n\
    value = value & 0x1; /* 0x1=1Bit, 0x3=2Bits, 0x7=3Bits */\nswitch (value) { \n\
    \  case 0x0: return std::string(\"Standby\");\n  case 0x1: return std::string(\"\
    Running\");\n  default: return std::string(\"Unknown\");\n}\nreturn x;"
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Register'
  register_type: read
  address: 12802
  raw_encode: HEXBYTES
  lambda: !lambda |-
    return x;
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BAT: Battery Status Temperature'
  address: 12800
  register_type: read
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 4;\nvalue = value & 0xf; \nswitch (value) { \n  case 0x0: return\
    \ std::string(\"Normal\");\n  case 0x1: return std::string(\"Over Temp\");\n \
    \ case 0x2: return std::string(\"Low Temp\");\n  default: return std::string(\"\
    Unknown\");\n}\nreturn x;"
  icon: mdi:thermometer
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BAT: Battery Status Voltage'
  address: 12800
  register_type: read
  raw_encode: NONE
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value & 0xf; \nswitch (value) { \n  case 0x0: return std::string(\"Normal\"\
    );\n  case 0x1: return std::string(\"Over Voltage\");\n  case 0x2: return std::string(\"\
    Under Voltage\");\n  case 0x3: return std::string(\"Over Discharge\");\n  case\
    \ 0x4: return std::string(\"Fault\");\n  default: return std::string(\"Unknown\"\
    );\n}\nreturn x;"
  icon: mdi:sine-wave
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  register_count: 0
  response_size: 2
switch:
- platform: modbus_controller
  modbus_controller_id: epever
  register_type: coil
  force_new_range: true
  address: 0
  bitmask: 0x01
  name: 'MPPT OP: Turn Charging Device On'
  icon: mdi:toggle-switch
  disabled_by_default: false
  restore_mode: DISABLED
  skip_updates: 0
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  modbus_controller_id: epever
  register_type: coil
  force_new_range: true
  address: 2
  bitmask: 0x01
  name: 'MPPT OP: Manual Load Control'
  icon: mdi:toggle-switch
  disabled_by_default: false
  restore_mode: DISABLED
  skip_updates: 0
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  register_type: coil
  address: 3
  bitmask: 0x01
  name: 'MPPT OP: Auto Load Control'
  icon: mdi:toggle-switch
  restore_mode: DISABLED
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  register_type: coil
  address: 5
  bitmask: 0x01
  name: 'MPPT OP: Enable Load Test Mode'
  icon: mdi:toggle-switch
  restore_mode: DISABLED
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  register_type: coil
  address: 6
  bitmask: 0x01
  name: 'MPPT OP: Load Test Load Control'
  icon: mdi:toggle-switch
  restore_mode: DISABLED
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: reset_to_fabric_default
  name: 'MPPT OP: Restore System Defaults'
  register_type: coil
  address: 19
  bitmask: 0x01
  icon: mdi:nuke
  restore_mode: DISABLED
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  id: clear_energy_stats
  register_type: coil
  address: 20
  bitmask: 0x01
  name: 'MPPT OP: Clear Stats'
  icon: mdi:eraser
  restore_mode: DISABLED
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
button:
- platform: template
  name: 'MPPT OP: Update System Time'
  on_press:
  - then:
    - script.execute:
        id: update_rtc
  disabled_by_default: false
- platform: template
  name: 'MPPT RT: Battery SOC Ah Reset'
  on_press:
  - then:
    - lambda: !lambda |-
        id(mppt_rt_battery_soc_ah).reset();
  disabled_by_default: false
- platform: template
  name: 'MPPT BP: Write Battery Parameters'
  on_press:
  - then:
    - script.execute:
        id: update_battery_params
  disabled_by_default: false
- platform: restart
  id: restart_button
  name: MPPT ESP Restart
  entity_category: diagnostic
  disabled_by_default: false
  device_class: restart
binary_sensor:
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging MOSFET Short Circuit'
  register_type: read
  address: 12801
  bitmask: 0x2000
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging or Anti-reverse MOSFET Open Circuit'
  register_type: read
  address: 12801
  bitmask: 0x1000
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Anti-reverse MOSFET Short Circuit'
  register_type: read
  address: 12801
  bitmask: 0x800
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Input Over Current'
  register_type: read
  address: 12801
  bitmask: 0x400
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Load Over Current'
  register_type: read
  address: 12801
  bitmask: 0x200
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Load Short Circuit'
  register_type: read
  address: 12801
  bitmask: 0x100
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Load MOSFET Short Circuit'
  register_type: read
  address: 12801
  bitmask: 0x80
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging Disequilibrium in three'
  register_type: read
  address: 12801
  bitmask: 0x40
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT CHG: Charging PV Input Short Circuit'
  register_type: read
  address: 12801
  bitmask: 0x20
  icon: mdi:battery-alert-variant
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Short Circuit'
  register_type: read
  address: 12802
  bitmask: 0x800
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Unable To Discharge'
  register_type: read
  address: 12802
  bitmask: 0x400
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Unable To Stop'
  register_type: read
  address: 12802
  bitmask: 0x200
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Output Voltage Abnormal'
  register_type: read
  address: 12802
  bitmask: 0x100
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Input Over Voltage'
  register_type: read
  address: 12802
  bitmask: 0x80
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging HV Short Circuit'
  register_type: read
  address: 12802
  bitmask: 0x40
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Boost Over Voltage'
  register_type: read
  address: 12802
  bitmask: 0x20
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT DIS: Discharging Output Over Voltage'
  register_type: read
  address: 12802
  bitmask: 0x10
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BAT: Battery Wrong Identification For Rated Voltage'
  register_type: read
  address: 12800
  bitmask: 0x8000
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BAT: Battery Inner Resistance Abnormal'
  register_type: read
  address: 12800
  bitmask: 0x100
  icon: mdi:battery-alert-variant-outline
  device_class: problem
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
number:
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36887
  name: 'MPPT BP: Battery Upper Temperature Limit'
  icon: mdi:thermometer-alert
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  multiply: 100.0
  use_write_multiple: true
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  max_value: 16777215.0
  min_value: -16777215.0
  step: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36888
  name: 'MPPT BP: Battery Lower Temperature Limit'
  icon: mdi:thermometer-alert
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  multiply: 100.0
  use_write_multiple: true
  min_value: -40.0
  max_value: 0.0
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT SET: Backlight time'
  address: 36963
  value_type: U_WORD
  register_type: holding
  unit_of_measurement: s
  min_value: 0.0
  max_value: 999.0
  step: 1.0
  icon: mdi:television-ambient-light
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
  use_write_multiple: false
- platform: modbus_controller
  id: x903e_h
  modbus_controller_id: epever
  name: 'MPPT LC: #2 Duration After Sunset (h) - 0=Off'
  register_type: holding
  address: 36926
  bitmask: 0xFF00
  value_type: U_WORD
  unit_of_measurement: h
  icon: mdi:timer
  min_value: 0.0
  max_value: 23.0
  use_write_multiple: true
  mode: BOX
  write_lambda: !lambda |-
    int h = static_cast<int>(x);
    int m = static_cast<int>(id(x903e_m).state);
    uint16_t value = ((h << 8) | m);
    ESP_LOGI("epever_mppt_controller", "Duration After Sunset %f", static_cast<double>(value));
    return static_cast<double>(value);
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
- platform: modbus_controller
  id: x903e_m
  modbus_controller_id: epever
  name: 'MPPT LC: #2 Duration After Sunset (m) - 0=Off'
  register_type: holding
  address: 36926
  bitmask: 0xFF
  value_type: U_WORD
  unit_of_measurement: min
  icon: mdi:timer
  min_value: 0.0
  max_value: 59.0
  use_write_multiple: true
  mode: BOX
  write_lambda: !lambda |-
    int h = static_cast<int>(id(x903e_h).state);
    int m = static_cast<int>(x);
    uint16_t value = ((h << 8) | m);
    ESP_LOGI("epever_mppt_controller", "Duration After Sunset %f", static_cast<double>(value));
    return static_cast<double>(value);
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
- platform: modbus_controller
  id: x903f_h
  modbus_controller_id: epever
  name: 'MPPT LC: #2 Duration Before Sunrise (h) - 0=Off'
  register_type: holding
  address: 36927
  bitmask: 0xFF00
  value_type: U_WORD
  unit_of_measurement: h
  icon: mdi:timer
  min_value: 0.0
  max_value: 23.0
  use_write_multiple: true
  mode: BOX
  write_lambda: !lambda |-
    item->state = x;
    int h = static_cast<int>(x);
    int m = static_cast<int>(id(x903f_m).state);
    uint16_t value = ((h << 8) | m);
    // ESP_LOGI("epever_mppt_controller", "Duration Before Sunrise %f", static_cast<double>(value));
    return static_cast<double>(value);
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: x903f_m
  name: 'MPPT LC: #2 Duration Before Sunrise (m) - 0=Off'
  register_type: holding
  address: 36927
  bitmask: 0xFF
  value_type: U_WORD
  unit_of_measurement: min
  icon: mdi:timer
  min_value: 0.0
  max_value: 59.0
  use_write_multiple: true
  mode: BOX
  write_lambda: !lambda |-
    item->state = x;
    int h = static_cast<int>(id(x903f_h).state);
    int m = static_cast<int>(x);
    uint16_t value = ((h << 8) | m);
    // ESP_LOGI("epever_mppt_controller", "Duration Before Sunrise %f", static_cast<double>(value));
    return static_cast<double>(value);
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: x901e
  address: 36894
  name: 'MPPT LC: #3 Night Time Threshold Voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.1
  icon: mdi:weather-sunset-down
  multiply: 100.0
  write_lambda: !lambda |-
    item->state = x;
    id(update_nttv).execute();
    return {};
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  id: x901f
  modbus_controller_id: epever
  address: 36895
  name: 'MPPT LC: #3 Night Time Hysteresis Light'
  unit_of_measurement: min
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 60.0
  icon: mdi:weather-sunset-down
  mode: BOX
  write_lambda: !lambda |-
    item->state = x;
    id(update_nttv).execute();
    return {};
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
  use_write_multiple: false
- platform: modbus_controller
  modbus_controller_id: epever
  id: x9020
  address: 36896
  name: 'MPPT LC: #3 Day Time Threshold Voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.1
  icon: mdi:weather-sunset-up
  multiply: 100.0
  write_lambda: !lambda |-
    item->state = x;
    id(update_nttv).execute();
    return {};
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  use_write_multiple: false
- platform: modbus_controller
  modbus_controller_id: epever
  id: x9021
  address: 36897
  name: 'MPPT LC: #3 Day Time Hysteresis Light'
  unit_of_measurement: min
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 60.0
  icon: mdi:weather-sunset-up
  mode: BOX
  write_lambda: !lambda |-
    item->state = x;
    id(update_nttv).execute();
    return {};
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
  multiply: 1.0
  use_write_multiple: false
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9001
  address: 36865
  name: 'MPPT BP: Battery Capacity'
  unit_of_measurement: Ah
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 9999.0
  step: 1.0
  icon: mdi:battery-high
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9002
  address: 36866
  name: 'MPPT BP: Temperature Compensation Coefficient'
  unit_of_measurement: mV/°C/2V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 9.0
  step: 0.01
  icon: mdi:thermometer-lines
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9003
  address: 36867
  name: 'MPPT BP: Over Voltage disconnect'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-off
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9004
  address: 36868
  name: 'MPPT BP: Charging limit voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-arrow-down
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9005
  address: 36869
  name: 'MPPT BP: Over voltage reconnect'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-sync
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9006
  address: 36870
  name: 'MPPT BP: Equalization Voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-charging-90
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9007
  address: 36871
  name: 'MPPT BP: Boost Voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-charging-90
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9008
  address: 36872
  name: 'MPPT BP: Float Voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-charging-100
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg9009
  address: 36873
  name: 'MPPT BP: Boost reconnect voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-charging-60
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg900a
  address: 36874
  name: 'MPPT BP: Low voltage reconnect'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-alert-variant-outline
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg900b
  address: 36875
  name: 'MPPT BP: Under Voltage Warning Recover'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-alert-variant-outline
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg900c
  address: 36876
  name: 'MPPT BP: Under Voltage Warning'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-alert-variant-outline
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg900d
  address: 36877
  name: 'MPPT BP: Low voltage disconnect'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-off-outline
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg900e
  address: 36878
  name: 'MPPT BP: Discharging limit voltage'
  unit_of_measurement: V
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 99.0
  step: 0.01
  icon: mdi:battery-arrow-up-outline
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  multiply: 100.0
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36880
  name: 'MPPT BP: Li Low Temp Charging Limit'
  icon: mdi:thermometer-alert
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  multiply: 100.0
  use_write_multiple: true
  min_value: -40.0
  max_value: 10.0
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36881
  name: 'MPPT BP: Li Low Temp Discharging Limit'
  icon: mdi:thermometer-alert
  unit_of_measurement: °C
  register_type: holding
  value_type: S_WORD
  multiply: 100.0
  use_write_multiple: true
  min_value: -40.0
  max_value: 10.0
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  step: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg906b
  address: 36971
  name: 'MPPT BP: Equalize Duration'
  unit_of_measurement: min
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 999.0
  step: 1.0
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  icon: mdi:battery-clock
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg906c
  address: 36972
  name: 'MPPT BP: Boost Duration'
  unit_of_measurement: min
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 999.0
  step: 1.0
  icon: mdi:battery-clock
  use_write_multiple: true
  write_lambda: !lambda |-
    item->state = x;
    id(update_battery_params).execute();
    return {};
  disabled_by_default: false
  mode: AUTO
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg906d
  address: 36973
  name: 'MPPT BP: SOC Mode Battery discharge'
  unit_of_measurement: '%'
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 100.0
  step: 1.0
  use_write_multiple: true
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
- platform: modbus_controller
  modbus_controller_id: epever
  id: reg906e
  address: 36974
  name: 'MPPT BP: SOC Mode Battery charge (DoC)'
  unit_of_measurement: '%'
  register_type: holding
  value_type: U_WORD
  min_value: 0.0
  max_value: 100.0
  step: 1.0
  use_write_multiple: true
  mode: BOX
  disabled_by_default: false
  bitmask: 0xFFFFFFFF
  skip_updates: 0
  force_new_range: false
  response_size: 0
  multiply: 1.0
select:
- platform: modbus_controller
  modbus_controller_id: epever
  id: load_controlling_modes_select
  name: 'MPPT LC: # Load Control Mode'
  address: 36925
  value_type: U_WORD
  optionsmap:
    '#0 Manual Control': 0
    '#1 Time Control 9042/9045 9069: 9048/904b': 1
    '#2 Light(Duration after Sunset, before Sunrise) 903e/903f/9065': 2
    '#3 Light(Voltage/Delay)': 3
  icon: mdi:electric-switch
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  disabled_by_default: true
  modbus_controller_id: epever
  address: 36969
  name: 'MPPT LC: #1 Time Control Mode'
  optionsmap:
    Only Timer 1: 0
    Timer 1 & Timer 2: 1
  value_type: U_WORD
  icon: mdi:timer
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  address: 36970
  name: 'MPPT LC: #0 Manual Mode Default'
  optionsmap:
    'Off': 0
    'On': 1
  value_type: U_WORD
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  id: battery_type
  name: 'MPPT BP: Battery Type'
  address: 36864
  value_type: U_WORD
  optionsmap:
    User Defined: 0
    Sealed: 1
    Gel: 2
    Flooded: 3
    LiFePO4 (4s): 4
    LiFePO4 (8s): 5
    LiFePO4 (15s): 6
    LiFePO4 (16s): 7
    Li(NiCoMn)O2 (3s): 8
    Li(NiCoMn)O2 (6s): 9
    Li(NiCoMn)O2 (7s): 10
    Li(NiCoMn)O2 (13s): 11
    Li(NiCoMn)O2 (14s): 12
  icon: mdi:battery-unknown
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BP: Battery Rated Voltage Level'
  address: 36967
  value_type: U_WORD
  optionsmap:
    Auto: 0
    12V: 1
    24V: 2
    36V: 3
    48V: 4
    60V: 5
    110V: 6
    120V: 7
    220V: 8
    240V: 9
  icon: mdi:sine-wave
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BP: Charging Mode'
  address: 36976
  value_type: U_WORD
  optionsmap:
    Voltage Compensation: 0
    SOC: 1
  icon: mdi:battery-unknown
  disabled_by_default: false
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BP: Li Over Temp. Drop Power'
  address: 37127
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 11;\nvalue = value & 0x1; \nswitch (value) { \n  case 0x0: return\
    \ std::string(\"Disable\");\n  case 0x1: return std::string(\"Enable\");\n  default:\
    \ return std::string(\"Unknown\");\n}"
  write_lambda: !lambda |-
    return {};
  optionsmap:
    Disable: 0
    Enable: 1
    Unknown: 99
  icon: mdi:thermometer
  disabled_by_default: false
  value_type: U_WORD
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BP: Li Low Temp Protection For Discharging'
  address: 37127
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 9;\nvalue = value & 0x1; \nswitch (value) { \n  case 0x0: return\
    \ std::string(\"Disable\");\n  case 0x1: return std::string(\"Enable\");\n  default:\
    \ return std::string(\"Unknown\");\n}"
  write_lambda: !lambda |-
    return {};
  optionsmap:
    Disable: 0
    Enable: 1
    Unknown: 99
  icon: mdi:thermometer
  disabled_by_default: false
  value_type: U_WORD
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
- platform: modbus_controller
  modbus_controller_id: epever
  name: 'MPPT BP: Li Low Temp Protection For Charging'
  address: 37127
  lambda: !lambda "uint16_t value = (data[item->offset] << 8) + data[item->offset+1];\n\
    value = value >> 8;\nvalue = value & 0x1; \nswitch (value) { \n  case 0x0: return\
    \ std::string(\"Disable\");\n  case 0x1: return std::string(\"Enable\");\n  default:\
    \ return std::string(\"Unknown\");\n}"
  write_lambda: !lambda |-
    return {};
  optionsmap:
    Disable: 0
    Enable: 1
    Unknown: 99
  icon: mdi:thermometer
  disabled_by_default: false
  value_type: U_WORD
  skip_updates: 0
  force_new_range: false
  use_write_multiple: false
  optimistic: false
script:
- id: update_nttv
  then:
  - lambda: !lambda "esphome::modbus_controller::ModbusController *controller = id(epever);\n\
      \nstd::vector<uint16_t> values = {\n  (uint16_t)(id(x901e).state * 100),  //\
      \ NTTV\n  (uint16_t)(id(x901f).state),        // Delay \n  (uint16_t)(id(x9020).state\
      \ * 100),  // DTTV\n  (uint16_t)(id(x9021).state)         // Delay\n};\n   \
      \ \nesphome::modbus_controller::ModbusCommandItem cmd =\n    esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(\n\
      \      controller, 0x901e, values.size(), values\n    );\ndelay(200);\ncontroller->queue_command(cmd);\n\
      \ndelay(200);\nfor(std::vector<uint16_t>::size_type i = 0; i != values.size();\
      \ i++) {\n  ESP_LOGI(\"epever_mppt_controller\", \"NTTV %x: %d\", i + 0x9000,\
      \ values[i]);\n}"
  mode: single
  parameters: {}
- id: update_battery_params
  then:
  - lambda: !lambda "esphome::modbus_controller::ModbusController *controller = id(epever);\n\
      \nstd::vector<uint16_t> bat_params = {\n  0,                               \
      \     // Battery Type User\n  (uint16_t)(id(reg9001).state),        // Battery\
      \ capacity (Ah)\n  (uint16_t)(id(reg9002).state * 100),  // Temperature compensation\
      \ coefficient\n  (uint16_t)(id(reg9003).state * 100),  // Over voltage disconnect\
      \ voltage (Load)\n  (uint16_t)(id(reg9004).state * 100),  // Charging limit\
      \ voltage (highest voltage the controller will allow charging)\n  (uint16_t)(id(reg9005).state\
      \ * 100),  // Over voltage reconnect voltage (Load)\n  (uint16_t)(id(reg9006).state\
      \ * 100),  // Equalize charging voltage\n  (uint16_t)(id(reg9007).state * 100),\
      \  // Boost charging voltage\n  (uint16_t)(id(reg9008).state * 100),  // Float\
      \ charging voltage\n  (uint16_t)(id(reg9009).state * 100),  // Boost reconnect\
      \ charging voltage\n  (uint16_t)(id(reg900a).state * 100),  // Low voltage reconnect\
      \ voltage (load)\n  (uint16_t)(id(reg900b).state * 100),  // Under voltage warning\
      \ recover voltage\n  (uint16_t)(id(reg900c).state * 100),  // Under voltage\
      \ warning voltage\n  (uint16_t)(id(reg900d).state * 100),  // Low voltage disconnect\
      \ voltage (load)\n  (uint16_t)(id(reg900e).state * 100)   // Discharging limit\
      \ voltage (lowest voltage the controller will allow discharging)\n};\n    \n\
      esphome::modbus_controller::ModbusCommandItem write_bat_params =\n    esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(\n\
      \      controller, 0x9000, bat_params.size(), bat_params\n    );\ndelay(200);\n\
      controller->queue_command(write_bat_params);\ndelay(200);\nfor(std::vector<uint16_t>::size_type\
      \ i = 0; i != bat_params.size(); i++) {\n  ESP_LOGI(\"epever_mppt_controller\"\
      , \"Battery Parameter %x: %d\", i + 0x9000, bat_params[i]);\n}\n\n// Charge\
      \ Timers\nstd::vector<uint16_t> bat_timers = {\n    (uint16_t)id(reg906b).state,\
      \ // Equalize Duration\n    (uint16_t)id(reg906c).state  // Boost Duration\n\
      };\nesphome::modbus_controller::ModbusCommandItem write_bat_timers =\n    esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(\n\
      \      controller, 0x906b, bat_timers.size(), bat_timers\n    );\ndelay(200);\n\
      controller->queue_command(write_bat_timers);\ndelay(200);\nfor(std::vector<uint16_t>::size_type\
      \ i = 0; i != bat_timers.size(); i++) {\n  ESP_LOGI(\"epever_mppt_controller\"\
      , \"Battery Timer %x: %d\", i + 0x906b, bat_timers[i]);\n}\n\nESP_LOGW(\"epever_mppt_controller\"\
      , \"Battery Parameters have been set!\");"
  mode: single
  parameters: {}
- id: update_rtc
  then:
  - lambda: !lambda |-
      auto now = id(sntp_time).now();

      if (!now.is_valid()) {
        ESP_LOGW("epever_mppt_controller", "RTC not valid yet. Skipping RTC Update.");
        return;
      }

      int s = now.second;
      int m = now.minute;
      int h = now.hour;
      int d = now.day_of_month;
      int M = now.month;
      int y = now.year % 100;

      uint16_t r1 = ((m << 8) | s);
      uint16_t r2 = ((d << 8) | h);
      uint16_t r3 = ((y << 8) | M);

      std::vector<uint16_t> rtc_data = {
        r1, r2, r3
      };

      for(std::vector<uint16_t>::size_type i = 0; i != rtc_data.size(); i++) {
        ESP_LOGI("epever_mppt_controller", "RTC Data to be sent: 0x%x: 0x%x", i + 0x9013, rtc_data[i]);
      }

      esphome::modbus_controller::ModbusController *controller = id(epever);
      esphome::modbus_controller::ModbusCommandItem cmd =
          esphome::modbus_controller::ModbusCommandItem::create_write_multiple_command(
            controller, 0x9013, 3, rtc_data
          );
      delay(200);
      controller->queue_command(cmd);
      delay(200);

      ESP_LOGI("epever_mppt_controller", "RTC updated to %04d-%02d-%02d %02d:%02d:%02d", y+2000, M, d, h, m, s);
  mode: single
  parameters: {}
wifi:
  domain: .local
  reboot_timeout: 15min
  power_save_mode: LIGHT
  fast_connect: false
  passive_scan: false
  enable_on_boot: true
  networks:
  - ssid: \033[5mEXTREME\033[6m
    password: \033[5mX2erZisRGFM7MepT\033[6m
    priority: 0.0
  use_address: tracer.local
dashboard_import:
  package_import_url: github://cubinet-code/esphome-packages/epever_mppt_controller.yaml@main
  import_full_config: false
logger:
  level: INFO
  baud_rate: 115200
  tx_buffer_size: 512
  deassert_rts_dtr: false
  hardware_uart: UART0
  logs: {}
web_server:
  port: 80
  version: 2
  enable_private_network_access: true
  include_internal: false
  ota: true
  log: true
  css_url: ''
  js_url: https://oi.esphome.io/v2/www.js
time:
- platform: sntp
  id: sntp_time
  update_interval: 24h
  timezone: CET-1CEST,M3.5.0,M10.5.0/3
  servers:
  - de.pool.ntp.org
  on_time_sync:
  - then:
    - script.execute:
        id: update_rtc
api:
  reboot_timeout: 0s
  port: 6053
  password: \033[5m''\033[6m
ota:
  on_error:
  - then:
    - button.press:
        id: restart_button
  safe_mode: true
  port: 3232
  reboot_timeout: 5min
  num_attempts: 10
uart:
- tx_pin:
    number: 19
    mode:
      output: true
      input: false
      open_drain: false
      pullup: false
      pulldown: false
    drive_strength: 20.0
    ignore_strapping_warning: false
    inverted: false
  rx_pin:
    number: 18
    mode:
      input: true
      output: false
      open_drain: false
      pullup: false
      pulldown: false
    drive_strength: 20.0
    ignore_strapping_warning: false
    inverted: false
  baud_rate: 115200
  stop_bits: 1
  rx_buffer_size: 256
  data_bits: 8
  parity: NONE
modbus:
- id: modbus1
  flow_control_pin:
    number: 23
    mode:
      output: true
      input: false
      open_drain: false
      pullup: false
      pulldown: false
    drive_strength: 20.0
    ignore_strapping_warning: false
    inverted: false
  send_wait_time: 200ms
  disable_crc: false
modbus_controller:
- id: epever
  address: 0x01
  update_interval: 10s
  command_throttle: 0ms
  offline_skip_updates: 0

